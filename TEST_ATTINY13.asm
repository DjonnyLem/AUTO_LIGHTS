.DEVICE ATtiny13
.INCLUDE "tn13def.inc"


	.DEF	FLAG = R20; 	–≈√»—“– ‘À¿√¿ —Œ—“ŒﬂÕ»…
;FLAF 0b76543210
;		||||||||__-‘À¿√ œ≈–≈œŒÀÕ≈Õ»ﬂ “¿…Ã≈–¿
;		|||||||___
;		||||||____
;		|||||_____
;		||||______-‘À¿√ Õ¿—“”œÀ≈Õ»ﬂ —Œ¡€“»ﬂ "À¿Ãœ¿ «¿–ﬂƒ » ¿  ”Ã”Àﬂ“Œ–¿ ¬€ À." (PB1)
;		|||_______-‘À¿√ Õ¿—“”œÀ≈Õ»ﬂ —Œ¡€“»ﬂ "¬ À. √¿¡¿–»“Œ¬" (PB2)
;		||________-‘À¿√ Õ¿—“”œÀ≈Õ»ﬂ —Œ¡€“»ﬂ "¬ À. –”◊ÕŒ√Œ “Œ–ÃŒ«¿" (PB3)
;		|_________-‘À¿√ Õ¿—“”œÀ≈Õ»ﬂ —Œ¡€“»ﬂ " ÕŒœ ¿ Õ¿∆¿“¿" (PB4)
 .DEF	TEMP = R16; 	–¿¡Œ◊»… –≈√»—“–

;=================================================
; —≈√Ã≈Õ“ SRAM œ¿Ãﬂ“»
.DSEG	


;=================================================
; —≈√Ã≈Õ“ EEPROM œ¿Ãﬂ“»
.ESEG				
;=================================================
; —≈√Ã≈Õ“ FLASH œ¿Ãﬂ“»
.CSEG


;******	INTERRUPT VECTORS		**************************************************
.ORG $000 
	RJMP RESET ; Reset Handler
.ORG $001
	RJMP EXT_INT0			; EXT_INT0 ; IRQ0 Handler
.ORG $002 
	RJMP PCINT01				; PCINT0 ; PCINT0 Handler
.ORG $003 
	RETI		 			; Timer0 Overflow Handler
.ORG $004 
	RETI					; EE_RDY ; EEPROM Ready Handler
.ORG $005 
	RETI					; ANA_COMP ; Analog Comparator Handler
.ORG $006
	RETI					; TIM0_COMPA ; Timer0 CompareA Handler	
.ORG $007 
	RETI					; TIM0_COMPB ; Timer0 CompareB Handler
.ORG $008 
	RETI					; WATCHDOG ; Watchdog Interrupt Handler
.ORG $009 
	RETI					; ADC ; ADC Conversion Handler


;******	INTERRUPTS				**************************************************

EXT_INT0:

    RETI

PCINT01:
	CLI					;«¿œ–≈Ÿ¿≈Ã œ–≈–€¬¿Õ»ﬂ
	LDI R16, 0<<INT0 | 0<<PCIE ; ”—“¿ÕŒ¬ Œ… 0 ¬ PCIE «¿œ–≈Ÿ¿≈Ã œ–≈–€¬¿Õ»ﬂ (ƒÀﬂ »— Àﬁ◊≈Õ»ﬂ ƒ–≈¡≈«√¿  ŒÕ“¿ “Œ¬)
    OUT GIMSK, R16

    IN R16, PINB		;«¿ÕŒ—»Ã ¬ –≈√»—“– TEMP «Õ¿◊≈Õ»ﬂ œŒ–“Œ¬ B
    ANDI R16, 0b00011110	;Ã¿— Œ… Œ◊»Ÿ¿≈Ã œŒ–“€ ¬ ¬ 0,  –ŒÃ≈ –¬1, –¬2, –¬3, –¬4
    LSL R16					; —Ã≈Ÿ¿≈Ã ¬À≈¬Œ «Õ¿◊≈Õ»ﬂ Õ¿ 3 «Õ¿ ¿
    LSL R16
    LSL R16
	ANDI FLAG Ob00001111	;Œ◊»Ÿ¿≈Ã «Õ¿◊≈Õ»ﬂ ¡»“Œ¬ 7-4 ¬Œ ‘À¿√≈
	OR FLAG,R16				;— œŒÃŒŸ‹ﬁ Ã¿— » «¿œ»—€¬¿≈Ã ¬Œ ‘À¿√ «Õ¿◊≈Õ»ﬂ 7-4 — –≈√»—“–¿, Õ≈ Ã≈Õﬂﬂ «Õ¿◊≈Õ»ﬂ 3-0
							;«¿œ”—  “¿…Ã≈–¿ «¿ƒ≈–∆ »

    RETI

;******	»Õ»÷»¿À»«¿÷»ﬂ —“≈ ¿		**************************************************
RESET:
	LDI		R16, 	RAMEND		; ¬€¡Œ– ¿ƒ–≈—¿ ¬≈–ÿ»Õ€ —“≈ ¿
	OUT		SPL,	R16 		; «¿œ»—‹ ≈√Œ ¬ –≈√»—“– —“≈ ¿
		

;*****	»Õ»÷»¿À»«¿÷»ﬂ œŒ–“Œ¬	**************************************************
;	–≈√»—“Œ– œŒ–“¿ –¬3 Õ¿ ¬’Œƒ, œŒƒ“ﬂ√»¬¿≈Ã ¬Õ”“–≈ÕÕ»… –≈√»—“–
	LDI R16, 1<<PB1 | 1<<PB2 | 1<<PB3 | 1<<PB4
	OUT DDRB, R16
	LDI R16, 1<<PB1 | 1<<PB2 | 1<<PB3 | 1<<PB4
	OUT PORTB, R16




;MCUCR ñ MCU Control Register ¬ÌÂ¯ÌËÈ Â„ËÒÚ ÛÔ‡‚ÎÂÌËˇ ÔÂ˚‚‡ÌËˇÏË A ÒÓ‰ÂÊËÚ ·ËÚ˚ ÛÔ‡‚ÎÂÌËˇ ‰Îˇ ÍÓÌÚÓÎˇ ÁÌ‡˜ÂÌËˇ ÔÂ˚‚‡ÌËÈ
    LDI R16, 0<<ISC01 | 1<<ISC00 	;00- ÔÂ˚‚‡ÌËÂ ÔÓ ÌËÁÍÓÏÛ ÛÓ‚Ì˛, 01- ÔÂ˚‚‡ÌËÂ ÔÓ ÎÓ„Ë˜ÂÒÍÓÏÛ ËÁÏÂÌÂÌË˛, 10- ÔÂ˚‚‡ÌËÂ ÔÓ ÌËÒÔ‡‰‡˛˘ÂÏÛ ÙÓÌÚÛ, 11- ÔÂ˚‚‡ÌËÂ ÔÓ Ì‡‡ÒÚ‡˛˘ÂÏÛ ÙÓÌÚÛ
    OUT MCUCR, R16
;GIMSKñ General Interrupt Mask Register –ÂÂÒÚ Ï‡ÒÓÍ ÔÂ˚‚‡ÌËÈ
    LDI R16, 0<<INT0 | 1<<PCIE 
    OUT GIMSK, R16
;GIFR ñ General Interrupt Flag Register Œ·˘ËÈ Â„ËÒÚ ÙÎ‡„Ó‚ ÔÂ˚‚‡ÌËÈ
    LDI R16, 0<<INTF0 | 1<<PCIF 
    OUT GIFR, R16
;PCMSK ñ Pin Change Mask Register
    LDI R16, 0<<PCINT5 | 1<<PCINT4 | 1<<PCINT3| 1<<PCINT2| 1<<PCINT1| 0<<PCINT0
    OUT PCMSK, R16
    SEI



MAIN:
	
    NOP
    RJMP MAIN



;00000000
;||||------- ‘À¿√ Õ¿—“”œÀ≈Õ»ﬂ —Œ¡€“»ﬂ " ÕŒœ ¿ Õ¿∆¿“¿" (PB4)
;|||-------- ‘À¿√ Õ¿—“”œÀ≈Õ»ﬂ —Œ¡€“»ﬂ "¬ À. –”◊ÕŒ√Œ “Œ–ÃŒ«¿" (PB3)
;||--------- ‘À¿√ Õ¿—“”œÀ≈Õ»ﬂ —Œ¡€“»ﬂ "¬ À. √¿¡¿–»“Œ¬" (PB2)
;|---------- ‘À¿√ Õ¿—“”œÀ≈Õ»ﬂ —Œ¡€“»ﬂ "À¿Ãœ¿ «¿–ﬂƒ » ¿  ”Ã”Àﬂ“Œ–¿ ¬€ À." (PB1)		

;00000000	‚ÒÂ ‚˚ÍÎ˛˜ÂÌÓ, ÂÊËÏ ÓÊË‰‡ÌËˇ ÒË„Ì‡Î‡	
;00010000	ÂÁÂ‚	
;00100000	ÌÂ ‡·ÓÚ‡ÂÏ	
;00110000	ÂÁÂ‚	
;01000000	ÌÂ ‡·ÓÚ‡ÂÏ	
;01010000	ÂÁÂ‚	
;01100000	ÌÂ ‡·ÓÚ‡Ï	
;01110000	ÂÁÂ‚	
;10000000	Á‡ÔÛÒÍ ÔÓ„‡ÏÏ˚	
;10010000	ÂÁÂ‚	
;10100000	ÓÚÍÎ˛˜. ¯ËÏ	
;10110000	ÂÁÂ‚	
;11000000	ÓÚÍÎ˛˜. ¯ËÏ	
;11010000	ÂÁÂ‚	
;11100000	ÓÚÍÎ˛˜. ¯ËÏ	
;11110000	ÂÁÂ‚	

MOV R17, FLAG
ANDI R17, 0b11110000
CPI R17, 0b00000000	;0
BREQ TASK0

CPI R17, 0b00010000	;1
BREQ TASK1

CPI R17, 0b10000000	;8
BREQ TASK1

TASK0:
	RJMP MAIN
TASK1:
	RJMP MAIN

TASK8:
;	«¿ƒ≈–∆ ¿ ¬ Àﬁ◊≈Õ»ﬂ
;	œÀ¿¬Õ€… ÿ»Ã (5-40%) Œ“ 13 ƒŒ 77 ¡»“Œ¬ (¬—≈√Œ 64)
;	
; “¿…Ã≈– œŒ œ≈–≈œŒÀÕ≈Õ»ﬁ —–¿¡¿“€¬¿≈“ — ◊¿—“Œ“Œ… 0,0034 —≈  
;(4800000 -◊¿—“Œ“¿ Ã , 64-œ–≈ƒƒ≈À»“≈À‹, “¿…Ã≈– œŒ œ≈–≈œŒÀÕ≈Õ»ﬁ -256 “¿ “Œ¬: 
;1/(4800000*64)*256 = 0,0034
; ¬–≈Ãﬂ –¿¡Œ“€ Õ¿–Œ—“¿ﬁŸ≈√Œ ÿ»Ã 3 —≈ . œŒÀ”◊¿≈Ã 3—≈  / 64 “¿ “¿ = 0,047 —≈  ŒƒÕŒ œ–»–Œ—“¿Õ»≈
; Ã€ ÃŒ∆≈Ã —◊»“€¬¿“‹ œŒ “¿…Ã≈–” œ–»–Œ—“¿Õ»≈ 0,047 / 0,0034 = 14 —–¿¡¿“€¬¿Õ»… “¿…Ã≈–¿ 1 œ–»–Œ—“¿Õ»≈

;
;	Œ—ÕŒ¬ÕŒ… ÿ»Ã
	RJMP MAIN

